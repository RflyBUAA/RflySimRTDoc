# 快速开始



## 2. 硬件连接

### 2.1 关键硬件清单

- ALINX MPSoC开发板, 开发板型号AXU2CG-E, 主控芯片型号XCZU2CG-SFVC784-1-E
- Pixhawk 4（该型号目前已经停售，可以替换为具有外置SPI接口的兼容PX4的自动驾驶仪。Pixhawk 6系类没有提供外置SPI接口）
- GH1.25转杜邦连接线
- [正点原子串口转wifi模块](https://detail.tmall.com/item.htm?spm=a230r.1.14.18.69a09754bcIZd5&id=609757779633&ns=1&abbucket=8&skuId=4447338308660)

<!-- WARNING: Pixhawk 4 目前已经停售，可以替换为具有外置SPI接口的兼容PX4的自动驾驶仪。Pixhawk 6系列没有提供外置SPI接口 -->

NOTE: Pixhawk 4 目前已经停售，可以替换为具有外置SPI接口的兼容PX4的自动驾驶仪。Pixhawk 6系列没有提供外置SPI接口

### 2.3 硬件接口定义图

将飞控与开发板对应引脚使用GH1.25杜邦线对应连接在一起, 引脚定义查看下面几副图.  

**pixhawk 4 接口定义图**

>> 每个接口的左数第一个引脚是PIN 1, 也就是VCC

<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627393529101-bbd46a6d-b028-48f9-b1b0-a6badc5ada6e.png#averageHue=%23ececec&height=506&id=u1c6491a7&originHeight=506&originWidth=428&originalType=binary&ratio=1&rotation=0&showTitle=false&size=46557&status=done&style=none&title=&width=428) -->

<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627450886931-a7743dbe-4e5b-4b0d-97b2-ea6686ae5a51.png#averageHue=%23889792&height=503&id=uf8126912&originHeight=648&originWidth=681&originalType=binary&ratio=1&rotation=0&showTitle=false&size=946513&status=done&style=none&title=&width=529) -->

<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627393619541-fd66ba9d-cb8c-450d-bf8c-02481b2a5b9d.png#averageHue=%23f4f3f3&height=472&id=u5bafd894&originHeight=472&originWidth=631&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44326&status=done&style=none&title=&width=631)! -->

<!-- [image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627393693107-afb43656-12c8-46db-96f1-55970b879e00.png#averageHue=%23f2f2f1&height=541&id=uea23bbf0&originHeight=541&originWidth=610&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54559&status=done&style=none&title=&width=610) -->

<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627393717322-62410e1c-ac24-4bff-a627-32462a05eb9c.png#averageHue=%23f4f3f2&height=714&id=u6d916738&originHeight=714&originWidth=627&originalType=binary&ratio=1&rotation=0&showTitle=false&size=69934&status=done&style=none&title=&width=627) -->

<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627393763560-84d2655c-e2a3-48df-995c-7c4f8fccc813.png#averageHue=%23f2f2f1&height=541&id=ud649b3cf&originHeight=541&originWidth=617&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57279&status=done&style=none&title=&width=617) -->

<!-- [Pixhawk4-Pinouts.pdf](https://www.yuque.com/attachments/yuque/0/2021/pdf/1166025/1627387378406-23e412b3-557b-4c01-bcb7-93daf58663f1.pdf) -->

**开发板IO接口定义图, 管脚和红框中的定义标记依次对应**

<!-- ![开发板管脚定义.png](https://cdn.nlark.com/yuque/0/2022/png/1166025/1651756798075-09daedfc-e1e9-42d0-aac4-1bae9356ed41.png#averageHue=%23889d87&clientId=u50b462d9-52dd-4&from=drop&id=u187c2ac2&originHeight=1191&originWidth=1739&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2924980&status=done&style=none&taskId=ubb531707-86c7-4ecd-9703-cf8405667d6&title=) -->

如上图, 将串口wifi模块安装到开发板对应的位置上(位置见上图左下角).  效果图如下

<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627398665804-20ddf57c-881a-4e30-9eb3-e97b722219c7.png#averageHue=%236b7274&height=434&id=u6f8a0674&originHeight=737&originWidth=821&originalType=binary&ratio=1&rotation=0&showTitle=false&size=799912&status=done&style=none&title=&width=484) -->

### 2.4 其他连接

1. 连接开发板的PS串口到电脑(该串口可用于系统调试, 建议使用[**MobaXterm**](https://mobaxterm.mobatek.net/)\[Putty](https://www.chiark.greenend.org.uk/~sgtatham/putty/)\[SecureCRT](https://www.vandyke.com/products/securecrt/index.html)之类的软件连接串口, 实现命令行功能, 串口助手之类的软件体验稍差)
2. 开发板电源([可以购买带开关的DC电源线, 免去电源插拔的繁琐操作](https://item.taobao.com/item.htm?spm=a1z09.2.0.0.32f12e8dZlbJXh&id=599221327119&_u=rqvdro2801a))

## 3. 飞控固件设置
SocFPGA HIL仿真平台通过模拟真实的传感器实现半物理仿真, 故而需要让飞控默认使用外置传感器与开发板进行通信, 故而**需要对飞控的传感器启动脚本进行简单修改重新编译烧录到飞控中**. 
**飞控固件支持的版本是v1.11，对于v1.12的支持请参考**[如何使用PX4 1.12固件](https://www.yuque.com/rflysocfpgahil/lkdltx/goxg0w?view=doc_embed)**, ** 对于使用RflySim可以在安装目录下找到飞控固件目录**X:\PX4PSP\Firmware\boards\px4\fmu-v5\init\中的rc.board_sensors文件, **
> 如果使用官方原生固件, 同理, 也需要到对应的目录Firmware\boards\px4\fmu-v5\init\下修改rc.board_sensors文件, 需要修改内容也是一样的

使用编辑器打开rc.board_sensors, 建议使用vscode之类的编辑软件编辑, 修改如下
```shell
#!/bin/sh
#
# PX4 FMUv5 specific board sensors init
#------------------------------------------------------------------------------

adc start
if ! icm20689 -S start
then
# Internal SPI bus ICM-20602
#icm20602 -s -R 2 start

# Internal SPI bus ICM-20689
icm20689 -s -R 2 start

# Internal SPI bus BMI055 accel/gyro
#bmi055 -A -R 2 -s start
#bmi055 -G -R 2 -s start

# internal compass
#ist8310 -I start
fi

if ! ms5611 -X start
then
# Baro on internal SPI
ms5611 -s start
fi
#icm20689 -S start
#ms5611 -X start
```
修改后的脚本逻辑是优先启动外置传感器, 如果启动失败则会启动内置传感器, 这样相同的固件可以不经修改既可以运行在本仿真平台上, 也可以实飞. 当然了, 还是建议仿真一个飞控, 实飞一个飞控.
**请再次确认飞控中安装的PX4飞控固件版本是1.11.3版本!**
**并且飞控的模式是四旋翼!**
## 4. 固件参数设置
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/1166025/1645510605585-f56a5cab-38cb-46b7-93a5-92def97cd6aa.png#averageHue=%23282524&clientId=u08cbd0eb-5f2e-4&from=paste&height=29&id=uf7b9a51d&originHeight=27&originWidth=640&originalType=binary&ratio=1&rotation=0&showTitle=false&size=5828&status=done&style=none&taskId=u4d86f03d-69a0-406a-b10f-8e0d3dbf3ee&title=&width=692) -->

<!-- ![image.png](https://cdn.nlark.com/yuque/0/2022/png/1166025/1645510733198-50b354c6-e1cd-4e29-a958-267e0006d63b.png#averageHue=%232a2725&clientId=u08cbd0eb-5f2e-4&from=paste&height=34&id=uebd37f1e&originHeight=30&originWidth=618&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7849&status=done&style=none&taskId=ucfdcfeab-6d4f-448e-bec2-5c6741fdb75&title=&width=692) -->
## 5. 开发板固件安装
开发板采用SD启动方式. 步骤如下:

1. 从开发板上取下SD卡, 使用读卡器将固件复制到SD卡根目录上.  固件下载链接：[https://bhpan.buaa.edu.cn:443/link/    1FF3201F500F3D00A9C483235A36B653](https://bhpan.buaa.edu.cn:443/link/1FF3201F500F3D00A9C483235A36B653)有效期限：2023-09-01 23:59
> **SD卡需要提前格式化为FAT32格式!! 一般默认也是FAT32格式. **
> **固件的名字必须是BOOT.bin**

2. 确保开发板的上电启动模式为SD卡模式(需要设置拨码开关).
> 拨码开关设置参考下图, 应设置为0101, 对应到图中从左到右是**上下上下**
<!-- > ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627396480265-8544e806-bcf6-4f0c-90a4-4988783e9080.png#averageHue=%231f211e&height=207&id=vJWr5&originHeight=396&originWidth=1160&originalType=binary&ratio=1&rotation=0&showTitle=false&size=810277&status=done&style=none&title=&width=605) -->

3. 将SD卡插回到开发板上.

完成以上设置后, 给开发板通电, 并且连接USB到电脑, 可以在设备管理器中看到(**可能需要安装驱动**), 使用串口终端连接串口
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627396642253-0f6ee54e-6d5b-46c9-a37d-6b2bbcdedeae.png#averageHue=%23f5f1ed&height=42&id=udbbda1a3&originHeight=42&originWidth=387&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7032&status=done&style=none&title=&width=387) -->
这里使用MobaXterm举例打开串口, 波特率设置为115200, 打开后在串口终端里输入**help**并且**回车**
<!-- ![shell.gif](https://cdn.nlark.com/yuque/0/2021/gif/1166025/1627397344446-6c638b00-be4e-493a-9173-5699fe8b41ee.gif#averageHue=%23fcfcfb&height=909&id=u456abdcb&originHeight=909&originWidth=1627&originalType=binary&ratio=1&rotation=0&showTitle=false&size=621814&status=done&style=none&title=&width=1627) -->
当然也可以先连接串口再打开开发板, 或者按下开发板的复位键, 应该能看到更多启动信息
<!-- ![shell2.gif](https://cdn.nlark.com/yuque/0/2021/gif/1166025/1627397631533-cf07ba30-2b24-49d6-9575-f814a48c3e06.gif#averageHue=%23262626&height=778&id=u638e1feb&originHeight=778&originWidth=1383&originalType=binary&ratio=1&rotation=0&showTitle=false&size=301592&status=done&style=none&title=&width=1383) -->
如果连接了串口转wifi模块, 此时打开RflySim3D软件应该可以看到一架四旋翼飞行器出现在窗口中(如果没有显示，可能是被防火墙拦截，可以先关闭防火墙)
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627397741790-b8d942db-2165-4b31-9297-0d349db6c5f7.png#averageHue=%234d5b39&height=720&id=u4672d79d&originHeight=720&originWidth=1280&originalType=binary&ratio=1&rotation=0&showTitle=false&size=2027812&status=done&style=none&title=&width=1280) -->

## 6. 飞控上电
此时为飞控连接电脑(确保已经按照前面步骤重刷修改过启动脚本的固件), 打开QGC可以看到地面站连接到飞控. 在地面站的控制台中输入sensors status 回车, 可以看到飞控读取到的传感器信息. 这里演示的QGC版本比较新, 旧版本操作可能有出入但是基本相同.
<!-- ![QGC.gif](https://cdn.nlark.com/yuque/0/2021/gif/1166025/1627398206891-71b4ba41-5aa9-42d5-94b8-8703440db8fa.gif#averageHue=%235d6769&height=913&id=ufc1a3e51&originHeight=913&originWidth=1708&originalType=binary&ratio=1&rotation=0&showTitle=false&size=7495071&status=done&style=none&title=&width=1708) -->
如果配置过程没问题得话, 可以获得传感器状态信息如下, 这些传感器数据实际上是FPGA模拟出来的, 飞控却会认为这是真实的传感器.  
<!-- ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1166025/1627398254378-871db728-274a-4df1-b0ba-6be5ac84584a.png#averageHue=%23383635&height=766&id=ud5bafd89&originHeight=766&originWidth=781&originalType=binary&ratio=1&rotation=0&showTitle=false&size=179455&status=done&style=none&title=&width=781) -->
如果没有上图效果请再次确认

- 飞控的Px4 版本是1.11.3.
- 且飞行模式是四旋翼模式.
- 确认飞控和开发板物理接线正确. 
- 检查地线是否正确连接.
